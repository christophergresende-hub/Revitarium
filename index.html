<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Revitarium — To-Do (PWA)</title>
<link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect rx='20' width='100' height='100' fill='%2300d08a'/><text x='50' y='60' font-family='Arial' font-size='46' fill='%23001200' text-anchor='middle'>R</text></svg>">
<style>
:root{
  --bg:#071027; --card:#0e2130; --muted:rgba(255,255,255,.6);
  --accent:#00d08a; --accent-600:#0ebc77; --radius:14px;
  --glass: rgba(255,255,255,0.03); --shadow: 0 8px 30px rgba(0,0,0,.6);
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#071227,#061226);color:#eaf6f2;-webkit-font-smoothing:antialiased}
.app{max-width:920px;margin:28px auto;padding:18px}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
.title{display:flex;flex-direction:column}
.title h1{margin:0;color:var(--accent);font-size:20px}
.title p{margin:0;color:var(--muted);font-size:12px}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);border:1px solid var(--glass)}
.controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
.input{flex:1;min-width:180px}
input[type="text"], input[type="date"], select{
  width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);
  background:rgba(0,0,0,0.14);color:inherit;font-size:14px;
}
.btn{padding:10px 12px;border-radius:10px;border:none;background:var(--accent);color:#022;cursor:pointer;font-weight:700}
.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
.row{display:flex;gap:10px;align-items:center}
.filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);cursor:pointer;color:var(--muted)}
.list{margin-top:8px}
.item{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:12px;margin-bottom:8px;background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.005));border:1px solid rgba(255,255,255,0.02)}
.left{display:flex;gap:12px;align-items:center;flex:1;min-width:0}
.check{width:40px;height:40px;border-radius:10px;border:2px solid rgba(255,255,255,0.06);display:inline-flex;align-items:center;justify-content:center;cursor:pointer;font-weight:800}
.check.done{background:var(--accent);border-color:var(--accent)}
.meta{font-size:12px;color:var(--muted)}
.titleTxt{font-weight:700;font-size:16px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.badge{padding:6px 8px;border-radius:8px;background:rgba(0,0,0,0.12);font-size:12px;color:var(--muted)}
.right{display:flex;gap:8px;align-items:center}
.small{font-size:12px;color:var(--muted)}
.empty{padding:18px;text-align:center;color:var(--muted)}
.footer{display:flex;justify-content:space-between;align-items:center;margin-top:10px;color:var(--muted);font-size:13px}
.modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.45)}
.modal .card{max-width:560px;width:94%}
.search{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:rgba(0,0,0,0.12);color:inherit}
@media(max-width:720px){.header{flex-direction:column;align-items:flex-start}.controls{flex-direction:column}.left{min-width:0}}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="title">
      <h1>Revitarium</h1>
      <p>To-Do avançado • Offline-ready • Backup/Import</p>
    </div>
    <div class="row">
      <button id="exportBtn" class="btn ghost">Exportar</button>
      <button id="importBtn" class="btn ghost">Importar</button>
      <button id="clearAll" class="btn ghost">Limpar tudo</button>
    </div>
  </div>

  <div class="card" id="appCard">
    <div class="controls">
      <div class="input">
        <input id="taskText" type="text" placeholder="Nova tarefa (descrição curta)" />
      </div>

      <div style="width:140px">
        <select id="categorySelect">
          <option value="">Categoria (opções)</option>
          <option value="Trabalho">Trabalho</option>
          <option value="Estudo">Estudo</option>
          <option value="Pessoal">Pessoal</option>
        </select>
      </div>

      <div style="width:120px">
        <select id="prioritySelect">
          <option value="normal">Prioridade: Normal</option>
          <option value="high">Alta</option>
          <option value="low">Baixa</option>
        </select>
      </div>

      <div style="width:150px">
        <input id="dueDate" type="date" />
      </div>

      <button id="addTaskBtn" class="btn">Adicionar</button>
    </div>

    <div class="filters">
      <input id="search" class="search" placeholder="Pesquisar..." />
      <div class="chips" id="chips"></div>
    </div>

    <div id="listWrap" class="list card" style="padding:12px">
      <div id="empty" class="empty">Nenhuma tarefa — adicione a primeira!</div>
      <div id="list" style="display:none"></div>
    </div>

    <div class="footer">
      <div class="small" id="stats">0 tarefas</div>
      <div class="small" id="lastSave">—</div>
    </div>
  </div>
</div>

<!-- Modal container for import -->
<div id="modalRoot" style="display:none"></div>

<script>
/* ---------- Config & Storage ---------- */
const APP_KEY = 'revitarium_v1';
const UNDO_KEY = 'revitarium_undo';
const CACHE_VERSION = 'rv-v1';
const ICON_SVG = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect rx='20' width='100' height='100' fill='%2300d08a'/><text x='50' y='60' font-family='Arial' font-size='46' fill='%23001200' text-anchor='middle'>R</text></svg>";

/* Helpers */
const $ = id => document.getElementById(id);
const now = ()=> new Date().toISOString();
const uid = ()=> 'id'+Math.random().toString(36).slice(2,9);

/* Load / Save */
function loadTasks(){ try{ return JSON.parse(localStorage.getItem(APP_KEY) || '[]'); }catch(e){ return []; } }
function saveTasks(tasks){ localStorage.setItem(APP_KEY, JSON.stringify(tasks)); $('lastSave').textContent = 'Salvo: '+ new Date().toLocaleTimeString(); }
function pushUndo(state){ localStorage.setItem(UNDO_KEY, JSON.stringify(state)); }
function popUndo(){ const s = localStorage.getItem(UNDO_KEY); localStorage.removeItem(UNDO_KEY); return s ? JSON.parse(s) : null; }

/* Initial state */
let tasks = loadTasks();
let filter = { q:'', category:'', priority:'' };

/* UI refs */
const taskText = $('taskText'), addTaskBtn = $('addTaskBtn'), listEl = $('list'), emptyEl = $('empty'), searchEl = $('search'), chipsEl = $('chips');
const exportBtn = $('exportBtn'), importBtn = $('importBtn'), clearAllBtn = $('clearAll'), statsEl = $('stats');

/* ---------- Render ---------- */
function render(){
  const q = filter.q.toLowerCase();
  const visible = tasks.filter(t=>{
    if(filter.category && t.category !== filter.category) return false;
    if(filter.priority && t.priority !== filter.priority) return false;
    if(q && !(t.text.toLowerCase().includes(q) || (t.notes||'').toLowerCase().includes(q))) return false;
    return true;
  });
  statsEl.textContent = tasks.length + ' tarefas • ' + visible.length + ' visíveis';
  listEl.innerHTML = '';
  if(!visible.length){ listEl.style.display='none'; emptyEl.style.display='block'; return; }
  emptyEl.style.display='none'; listEl.style.display='block';
  visible.forEach(t=>{
    const it = document.createElement('div'); it.className='item';
    const left = document.createElement('div'); left.className='left';
    const chk = document.createElement('button'); chk.className = 'check' + (t.done ? ' done' : ''); chk.innerHTML = t.done ? '✓' : '';
    chk.onclick = ()=> { pushUndo({tasks: structuredClone(tasks)}); t.done = !t.done; saveAndRender(); };
    const txt = document.createElement('div'); txt.style.width='100%';
    const title = document.createElement('div'); title.className='titleTxt'; title.textContent = t.text;
    const meta = document.createElement('div'); meta.className='meta'; meta.innerHTML = `<span class="badge">${t.category||'—'}</span> • ${t.priority} • ${t.due||'sem prazo'}`;
    txt.appendChild(title); txt.appendChild(meta);
    left.appendChild(chk); left.appendChild(txt);
    const right = document.createElement('div'); right.className='right';
    const edit = document.createElement('button'); edit.className='btn ghost'; edit.textContent='Editar'; edit.onclick = ()=> openEdit(t.id);
    const del = document.createElement('button'); del.className='btn'; del.textContent='Excluir'; del.onclick = ()=> { if(confirm('Excluir tarefa?')){ pushUndo({tasks: structuredClone(tasks)}); tasks = tasks.filter(x=>x.id!==t.id); saveAndRender(); } };
    right.appendChild(edit); right.appendChild(del);
    it.appendChild(left); it.appendChild(right);
    listEl.appendChild(it);
  });
}

/* ---------- Actions ---------- */
function addTask(){
  const text = taskText.value.trim(); if(!text) return;
  pushUndo({tasks: structuredClone(tasks)});
  tasks.unshift({ id: uid(), text, notes:'', category: $('categorySelect').value || '', priority: $('prioritySelect').value || 'normal', due: $('dueDate').value || '', done:false, created: now() });
  taskText.value=''; $('dueDate').value=''; saveAndRender();
}
function saveAndRender(){ saveTasks(tasks); render(); }
function openEdit(id){
  const t = tasks.find(x=>x.id===id); if(!t) return;
  showModal(`<h3>Editar</h3>
    <div style="margin-top:8px">
      <input id="m_text" type="text" value="${escapeHtml(t.text)}" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.1)" />
      <textarea id="m_notes" style="width:100%;height:90px;margin-top:8px;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.1)">${escapeHtml(t.notes||'')}</textarea>
      <div style="display:flex;gap:8px;margin-top:8px">
        <select id="m_category"><option value="">Categoria</option><option>Trabalho</option><option>Estudo</option><option>Pessoal</option></select>
        <select id="m_priority"><option value="normal">Normal</option><option value="high">Alta</option><option value="low">Baixa</option></select>
        <input id="m_due" type="date" />
      </div>
      <div style="text-align:right;margin-top:10px">
        <button id="m_cancel" class="btn ghost">Cancelar</button>
        <button id="m_save" class="btn">Salvar</button>
      </div>
    </div>`);
  $('m_text').value = t.text; $('m_notes').value = t.notes||''; $('m_category').value = t.category||''; $('m_priority').value = t.priority||'normal'; $('m_due').value = t.due||'';
  $('m_cancel').onclick = closeModal;
  $('m_save').onclick = ()=> { pushUndo({tasks: structuredClone(tasks)}); t.text = $('m_text').value.trim(); t.notes = $('m_notes').value; t.category = $('m_category').value; t.priority = $('m_priority').value; t.due = $('m_due').value; saveAndRender(); closeModal(); };
}

/* ---------- UI helpers ---------- */
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

function showModal(html){
  const root = $('modalRoot'); root.style.display='block'; root.innerHTML = `<div class="modal"><div class="card">${html}</div></div>`;
}
function closeModal(){ const root = $('modalRoot'); root.innerHTML=''; root.style.display='none'; }

/* ---------- Import/Export/Undo/Clear ---------- */
function exportJSON(){
  const blob = new Blob([JSON.stringify(tasks,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'revitarium_export.json'; document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },1500);
}
function importJSON(){
  showModal(`<h3>Importar JSON</h3>
    <p>Cole aqui o JSON do backup e clique em Importar (substitui as tarefas atuais).</p>
    <textarea id="imp" style="width:100%;height:160px"></textarea>
    <div style="text-align:right;margin-top:8px"><button id="imp_cancel" class="btn ghost">Cancelar</button><button id="imp_do" class="btn">Importar</button></div>`);
  $('imp_cancel').onclick = closeModal;
  $('imp_do').onclick = ()=> {
    try{
      const data = JSON.parse($('imp').value);
      if(!Array.isArray(data)) throw Error('Formato inválido');
      pushUndo({tasks: structuredClone(tasks)});
      tasks = data.map(x=>({ id: x.id||uid(), text: x.text||'', notes: x.notes||'', category: x.category||'', priority: x.priority||'normal', due: x.due||'', done: !!x.done, created: x.created||now() }));
      saveAndRender(); closeModal();
    }catch(e){ alert('Import falhou: '+e.message); }
  };
}
function undo(){
  const s = popUndo(); if(!s) { alert('Nada para desfazer'); return; }
  tasks = s.tasks || []; saveAndRender();
}
function clearAll(){
  if(!confirm('Apagar TODAS as tarefas?')) return;
  pushUndo({tasks: structuredClone(tasks)}); tasks = []; saveAndRender();
}

/* ---------- Filters / chips ---------- */
function buildChips(){
  chipsEl.innerHTML = '';
  const cats = [...new Set(tasks.map(t=>t.category).filter(Boolean))];
  const priorities = ['high','normal','low'];
  if(cats.length){
    cats.forEach(c=>{
      const ch = document.createElement('div'); ch.className='chip'; ch.textContent=c;
      ch.onclick = ()=> { filter.category = filter.category===c ? '' : c; render(); updateChips(); };
      chipsEl.appendChild(ch);
    });
  }
  priorities.forEach(p=>{
    const ch = document.createElement('div'); ch.className='chip'; ch.textContent = p; ch.onclick = ()=> { filter.priority = filter.priority===p ? '' : p; render(); updateChips(); };
    chipsEl.appendChild(ch);
  });
}
function updateChips(){ Array.from(chipsEl.children).forEach(ch=> ch.style.opacity = (filter.category && ch.textContent===filter.category) || (filter.priority && ch.textContent===filter.priority) ? '1' : '0.7'); }

/* ---------- Init UI ---------- */
addTaskBtn.onclick = addTask;
taskText.addEventListener('keydown', e=> { if(e.key==='Enter') addTask(); });
searchEl.addEventListener('input', e=> { filter.q = e.target.value; render(); });
exportBtn.onclick = exportJSON;
importBtn.onclick = importJSON;
clearAllBtn.onclick = clearAll;

/* quick action: long-press Undo via double click on title */
document.title = 'Revitarium';
buildChips();
render();

/* ---------- Service manifest & worker registration (dynamic Blobs) ---------- */
(function createManifestAndRegisterSW(){
  try{
    const manifest = {
      name: "Revitarium",
      short_name: "Revitarium",
      start_url: ".",
      display: "standalone",
      background_color:"#071227",
      theme_color:"#00d08a",
      icons: [{ src: ICON_SVG, sizes:"512x512", type:"image/svg+xml" }]
    };
    const mBlob = new Blob([JSON.stringify(manifest)], {type:'application/manifest+json'});
    const mUrl = URL.createObjectURL(mBlob);
    let link = document.querySelector('link[rel="manifest"]');
    if(!link){ link = document.createElement('link'); link.rel='manifest'; document.head.appendChild(link); }
    link.href = mUrl;
    window.__rv_manifest = mUrl;

    if('serviceWorker' in navigator){
      const sw = `
        const CACHE = '${CACHE_VERSION}';
        const ASSETS = ['/', '/index.html'];
        self.addEventListener('install', e=>{ e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS)).then(()=>self.skipWaiting())); });
        self.addEventListener('activate', e=>{ e.waitUntil(caches.keys().then(keys=>Promise.all(keys.map(k=> k!==CACHE ? caches.delete(k) : null))).then(()=>self.clients.claim())); });
        self.addEventListener('fetch', e=>{
          const req = e.request;
          if(req.method !== 'GET') return;
          if(req.mode === 'navigate' || (req.headers.get('accept')||'').includes('text/html')){
            e.respondWith(fetch(req).then(r=>{ const copy=r.clone(); caches.open(CACHE).then(c=>c.put(req,copy)); return r; }).catch(()=>caches.match('/index.html')));
            return;
          }
          e.respondWith(caches.match(req).then(c=> c || fetch(req).then(r=>{ caches.open(CACHE).then(cache=>{ try{ cache.put(req, r.clone()); }catch(e){} }); return r; }))));
        });
      `;
      const swBlob = new Blob([sw], {type:'text/javascript'});
      const swUrl = URL.createObjectURL(swBlob);
      navigator.serviceWorker.register(swUrl).catch(()=>{/*ignore*/});
      window.__rv_sw = swUrl;
    }
  }catch(e){ /* fail silently */ }
})();

/* ---------- small utilities ---------- */
(function autosaveStatus(){ const el = $('lastSave'); if(!el) return; setInterval(()=>{ el.textContent = 'Salvo: '+ new Date().toLocaleTimeString(); }, 60000); })();
</script>
</body>
</html>
