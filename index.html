<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Revitarium — To-Do</title>
<meta name="theme-color" content="#00d08a"/>
<link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect rx='20' width='100' height='100' fill='%2300d08a'/><text x='50' y='60' font-family='Arial' font-size='46' fill='%23001200' text-anchor='middle'>R</text></svg>">

<style>
:root{
  --bg:#06121b; --card:#0b2230; --accent:#00d08a; --muted:#9fb6bf; --glass: rgba(255,255,255,0.02);
  --radius:12px; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#06121b,#03101a);color:#e7fbf5}
.app{max-width:920px;margin:28px auto;padding:18px}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
.header h1{margin:0;color:var(--accent);font-size:20px}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:16px;border-radius:var(--radius);box-shadow:0 8px 30px rgba(0,0,0,0.6)}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
.input{flex:1;min-width:160px}
input[type="text"], select, textarea{
  width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);
  background:rgba(0,0,0,0.12);color:inherit;font-size:14px;
}
.btn{padding:10px 12px;border-radius:10px;border:none;background:var(--accent);color:#021;cursor:pointer;font-weight:700}
.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
.list{margin-top:12px;display:flex;flex-direction:column;gap:10px}
.item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;background:rgba(0,0,0,0.12)}
.left{display:flex;gap:12px;align-items:center;min-width:0}
.check{width:36px;height:36px;border-radius:9px;border:2px solid rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center;cursor:pointer}
.check.done{background:var(--accent);border-color:transparent}
.title{font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.meta{color:var(--muted);font-size:12px}
.footer{margin-top:12px;color:var(--muted);font-size:13px;text-align:center}
.small{font-size:13px;color:var(--muted)}
@media(max-width:520px){.controls{flex-direction:column}.header{flex-direction:column;align-items:flex-start}}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div>
      <h1>Revitarium</h1>
      <div class="small">To-Do avançado — Offline • Backup • Import</div>
    </div>
    <div style="display:flex;gap:8px">
      <button id="exportBtn" class="ghost">Export</button>
      <button id="importBtn" class="ghost">Import</button>
      <button id="clearBtn" class="ghost">Clear</button>
    </div>
  </div>

  <div class="card" id="card">
    <div class="controls">
      <div class="input">
        <input id="taskInput" type="text" placeholder="Nova tarefa (descrição curta)"/>
      </div>

      <div style="width:150px">
        <select id="category">
          <option value="">Categoria</option>
          <option>Work</option><option>Study</option><option>Personal</option>
        </select>
      </div>

      <div style="width:140px">
        <select id="priority">
          <option value="normal">Prioridade: Normal</option>
          <option value="high">Alta</option>
          <option value="low">Baixa</option>
        </select>
      </div>

      <button id="addBtn" class="btn">Adicionar</button>
    </div>

    <div style="display:flex;gap:8px;margin-bottom:8px">
      <input id="search" type="text" placeholder="Pesquisar..." style="padding:10px;border-radius:10px;background:rgba(0,0,0,0.08);border:1px solid rgba(255,255,255,0.02);flex:1"/>
      <button id="undoBtn" class="ghost">Desfazer</button>
    </div>

    <div id="list" class="list"></div>

    <div class="footer small" id="status">0 tarefas • Carregado</div>
  </div>
</div>

<!-- hidden file input for import -->
<input id="fileInput" type="file" accept="application/json" style="display:none"/>

<script>
/* ---------- Single-file PWA app
   - dynamic manifest & SW via Blob (no extra files)
   - localStorage backup & import/export
   - undo
*/
const APP_KEY = 'revitarium_v2';
const UNDO_KEY = 'revitarium_undo_v2';
let tasks = JSON.parse(localStorage.getItem(APP_KEY) || '[]');

const $ = id => document.getElementById(id);
const uid = () => 't'+Math.random().toString(36).slice(2,9);
const now = ()=> new Date().toISOString();

function save(){ localStorage.setItem(APP_KEY, JSON.stringify(tasks)); updateStatus(); }
function pushUndo(){ localStorage.setItem(UNDO_KEY, JSON.stringify(tasks)); }
function popUndo(){ const s=localStorage.getItem(UNDO_KEY); if(!s) return null; localStorage.removeItem(UNDO_KEY); return JSON.parse(s); }

function addTask(){
  const text = $('taskInput').value.trim(); if(!text) return alert('Digite a tarefa');
  pushUndo();
  tasks.unshift({ id: uid(), text, category: $('category').value||'', priority: $('priority').value||'normal', done:false, created: now() });
  $('taskInput').value=''; save(); render();
}
function removeTask(id){ pushUndo(); tasks = tasks.filter(t=>t.id!==id); save(); render(); }
function toggleDone(id){ pushUndo(); tasks = tasks.map(t=> t.id===id ? {...t,done:!t.done} : t); save(); render(); }
function clearAll(){ if(!confirm('Apagar todas as tarefas?')) return; pushUndo(); tasks=[]; save(); render(); }
function undo(){ const prev = popUndo(); if(!prev){ alert('Nada para desfazer'); return; } tasks = prev; save(); render(); }

function exportJSON(){
  const blob = new Blob([JSON.stringify(tasks,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='revitarium_backup_'+(new Date().toISOString().slice(0,10))+'.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
function importJSONFromText(txt){
  try{
    const arr = JSON.parse(txt);
    if(!Array.isArray(arr)) throw 0;
    pushUndo(); // keep undo
    // normalize
    const imported = arr.map(x=>({ id: x.id||uid(), text:x.text||x.title||'', category:x.category||'', priority:x.priority||'normal', done:!!x.done, created:x.created||now() }));
    tasks = imported.concat(tasks);
    save(); render(); alert('Importado: '+imported.length+' itens');
  }catch(e){ alert('Import falhou — JSON inválido'); }
}
function openFilePicker(){ $('fileInput').click(); }

$('fileInput').addEventListener('change', e=>{
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = ()=> importJSONFromText(r.result);
  r.readAsText(f);
  e.target.value = '';
});

/* render */
function render(){
  const list = $('list'); list.innerHTML='';
  const q = $('search').value.trim().toLowerCase();
  const visible = tasks.filter(t=> !q || (t.text + ' ' + t.category).toLowerCase().includes(q));
  if(!visible.length){ list.innerHTML = '<div class="small" style="padding:12px">Nenhuma tarefa</div>'; updateStatus(); return; }
  visible.forEach(t=>{
    const it = document.createElement('div'); it.className='item';
    const left = document.createElement('div'); left.className='left';
    const chk = document.createElement('button'); chk.className = 'check' + (t.done ? ' done':''); chk.textContent = t.done ? '✓' : '';
    chk.onclick = ()=> toggleDone(t.id);
    const txt = document.createElement('div'); txt.style.minWidth='0';
    const title = document.createElement('div'); title.className='title'; title.textContent = t.text;
    const meta = document.createElement('div'); meta.className='meta'; meta.textContent = (t.category? t.category+' • ':'') + t.priority + ' • ' + new Date(t.created).toLocaleString();
    txt.appendChild(title); txt.appendChild(meta);
    left.appendChild(chk); left.appendChild(txt);
    const right = document.createElement('div');
    const del = document.createElement('button'); del.className='ghost'; del.textContent='Excluir'; del.onclick = ()=> { if(confirm('Excluir?')) removeTask(t.id); };
    right.appendChild(del);
    it.appendChild(left); it.appendChild(right);
    list.appendChild(it);
  });
  updateStatus();
}

function updateStatus(){ $('status').textContent = tasks.length + ' tarefas • salvo localmente • ' + new Date().toLocaleTimeString(); }

/* events */
$('addBtn').onclick = addTask;
$('clearBtn').onclick = clearAll;
$('exportBtn').onclick = exportJSON;
$('importBtn').onclick = openFilePicker;
$('undoBtn').onclick = undo;
$('search').addEventListener('input', render);

/* initial */
render();

/* ---------- dynamic manifest + service worker registration ---------- */
(function(){
  try{
    // manifest blob
    const icon = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect rx='20' width='100' height='100' fill='%2300d08a'/><text x='50' y='60' font-family='Arial' font-size='46' fill='%23001200' text-anchor='middle'>R</text></svg>";
    const manifest = {
      name: "Revitarium",
      short_name: "Revitarium",
      start_url: ".",
      display: "standalone",
      background_color: "#06121b",
      theme_color: "#00d08a",
      icons: [{ src: icon, sizes: "512x512", type: "image/svg+xml" }]
    };
    const mBlob = new Blob([JSON.stringify(manifest)],{type:'application/manifest+json'});
    const mUrl = URL.createObjectURL(mBlob);
    let link = document.querySelector('link[rel="manifest"]');
    if(!link){ link = document.createElement('link'); link.rel = 'manifest'; document.head.appendChild(link); }
    link.href = mUrl;

    // service worker (dynamic)
    if('serviceWorker' in navigator){
      const sw = `
        const CACHE = 'revitarium-cache-v1';
        const ASSETS = ['/', '/index.html'];
        self.addEventListener('install', e => {
          e.waitUntil(caches.open(CACHE).then(c => c.addAll(ASSETS)).then(()=>self.skipWaiting()));
        });
        self.addEventListener('activate', e => {
          e.waitUntil(caches.keys().then(keys => Promise.all(keys.map(k=> k!==CACHE ? caches.delete(k) : null))).then(()=>self.clients.claim()));
        });
        self.addEventListener('fetch', e => {
          if(e.request.method !== 'GET') return;
          const req = e.request;
          if(req.mode === 'navigate' || (req.headers.get('accept')||'').includes('text/html')){
            e.respondWith(fetch(req).then(r=>{ const copy=r.clone(); caches.open(CACHE).then(c=>c.put(req,copy)); return r; }).catch(()=>caches.match('/index.html')));
            return;
          }
          e.respondWith(caches.match(req).then(cached => cached || fetch(req).then(res=>{ try{ if(res && res.status===200) caches.open(CACHE).then(cache=>cache.put(req,res.clone())); }catch(e){} return res; })));
        });
      `;
      const blob = new Blob([sw],{type:'text/javascript'});
      const swUrl = URL.createObjectURL(blob);
      navigator.serviceWorker.register(swUrl).catch(()=>{/* ignore */});
      // expose for debug
      window.__rv_sw = swUrl;
    }
  }catch(e){ console.error(e); }
})();
</script>
</body>
</html>
