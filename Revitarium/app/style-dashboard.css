/* dashboard.js - funcionalidades do dashboard */

/* ---------- Estado ---------- */
const STATE = {
  activities: [],
  todos: [],
  users: [],
  stats: {
    visits: [120,150,170,140,200,240,220],
    conversions: [5,8,6,9,12,7,10],
    labels: []
  },
  mockApi: true
};

/* Labels Ãºltimos 7 dias */
(function(){
  const l=[];
  for(let i=6;i>=0;i--){
    const d=new Date(); d.setDate(d.getDate()-i);
    l.push(d.toLocaleDateString());
  }
  STATE.stats.labels=l;
})();

const qs=s=>document.querySelector(s);
const qsa=s=>document.querySelectorAll(s);

/* ---------- PersistÃªncia ---------- */
const saveState=()=>localStorage.setItem('rev_state',JSON.stringify(STATE));
const loadState=()=>{
  const r=localStorage.getItem('rev_state');
  if(!r) return;
  try{ Object.assign(STATE,JSON.parse(r)); }catch(e){}
};

/* Mock fetch */
const fetchMock=(type)=>new Promise(r=>setTimeout(()=>{
  if(type==='cards') r({users:STATE.users.length, visits:STATE.stats.visits.reduce((a,b)=>a+b,0), tasks:STATE.todos.length});
  if(type==='activities') r(STATE.activities.slice(-6).reverse());
  if(type==='users') r(STATE.users);
  if(type==='todos') r(STATE.todos);
},300));

/* ProteÃ§Ã£o */
function requireAuth(){
  if(!sessionStorage.getItem('rev_logged')){
    window.location.href="index.html"; return false;
  }
  return true;
}

/* ---------- Render ---------- */
async function renderCards(){
  const el=qs('#cards'); el.innerHTML='';
  const d=await fetchMock('cards');
  [{t:'UsuÃ¡rios',v:d.users},{t:'Visitas',v:d.visits},{t:'Tarefas',v:d.tasks}]
  .forEach(c=>{
    const x=document.createElement('div');
    x.className='card';
    x.innerHTML=`<h4>${c.t}</h4><div class="value">${c.v}</div>`;
    el.appendChild(x);
  });
}

async function renderActivityList(){
  const el=qs('#activity-list'); el.innerHTML='';
  const a=await fetchMock('activities');
  a.forEach(x=>{
    const li=document.createElement('li');
    li.innerHTML=`<span>${x.text}</span><small>${new Date(x.time).toLocaleString()}</small>`;
    el.appendChild(li);
  });
}

async function renderTodos(){
  const el=qs('#todo-list'); el.innerHTML='';
  const t=await fetchMock('todos');
  t.forEach((x,i)=>{
    const li=document.createElement('li');
    li.innerHTML=`<span>${x.text}</span>
    <div>
      <button class="btn-ghost btn-tick" data-idx="${i}">âœ”</button>
      <button class="btn-ghost btn-del" data-idx="${i}">âœ–</button>
    </div>`;
    el.appendChild(li);
  });
}

async function renderUsers(){
  const el=qs('#users-list'); el.innerHTML='';
  const u=await fetchMock('users');
  u.forEach((x,i)=>{
    const li=document.createElement('li');
    li.style="display:flex;justify-content:space-between;align-items:center;";
    li.innerHTML=`<span>${x.name}</span>
      <div>
        <button class="btn-ghost btn-edit" data-idx="${i}">âœŽ</button>
        <button class="btn-ghost btn-user-del" data-idx="${i}">ðŸ—‘</button>
      </div>`;
    el.appendChild(li);
  });
}

/* GrÃ¡ficos */
let c1,c2;
function renderCharts(){
  if(c1) c1.destroy();
  if(c2) c2.destroy();

  c1=new Chart(qs('#chart-visits'),{
    type:'line',
    data:{
      labels:STATE.stats.labels,
      datasets:[{
        data:STATE.stats.visits,
        borderColor:'rgba(0,230,255,0.9)',
        backgroundColor:'rgba(0,230,255,0.12)',
        tension:0.3
      }]
    },
    options:{plugins:{legend:{display:false}}}
  });

  c2=new Chart(qs('#chart-conversions'),{
    type:'bar',
    data:{
      labels:STATE.stats.labels,
      datasets:[{
        data:STATE.stats.conversions,
        backgroundColor:'rgba(0,140,255,0.9)'
      }]
    },
    options:{plugins:{legend:{display:false}}}
  });
}

/* ---------- Eventos ---------- */
function bindEvents(){
  qs('#btn-logout').onclick=()=>{sessionStorage.removeItem('rev_logged');location.href='index.html';};

  qsa('.nav-item').forEach(x=>x.onclick=e=>{
    qsa('.nav-item').forEach(n=>n.classList.remove('active'));
    e.target.classList.add('active');
    const r=e.target.dataset.route;
    routeChange(r);
  });

  qs('#btn-export').onclick=exportCSV;

  qs('#btn-add-activity').onclick=()=>{
    STATE.activities.push({text:`AÃ§Ã£o ${Math.floor(Math.random()*999)}`, time:Date.now()});
    saveState(); renderActivityList();
  };

  qs('#btn-add-todo').onclick=()=>{
    const i=qs('#todo-input');
    if(!i.value.trim()) return;
    STATE.todos.push({text:i.value.trim(), created:Date.now()});
    i.value=''; saveState(); renderTodos(); renderCards();
  };

  qs('#todo-list').onclick=e=>{
    const i=Number(e.target.dataset.idx);
    if(e.target.classList.contains('btn-tick')){
      STATE.todos.splice(i,1);
      saveState(); renderTodos(); renderCards();
    }
    if(e.target.classList.contains('btn-del')){
      STATE.todos.splice(i,1);
      saveState(); renderTodos(); renderCards();
    }
  };

  qs('#btn-create-user').onclick=()=>{
    const n=qs('#new-user-name').value.trim();
    const p=qs('#new-user-pass').value.trim();
    if(!n||!p) return alert('Preencha os campos');
    STATE.users.push({name:n,pass:p,id:Date.now()});
    saveState(); renderUsers(); renderCards();
    qs('#new-user-name').value=''; qs('#new-user-pass').value='';
  };

  qs('#users-list').onclick=e=>{
    const i=Number(e.target.dataset.idx);
    if(e.target.classList.contains('btn-user-del')){
      STATE.users.splice(i,1);
      saveState(); renderUsers(); renderCards();
    }
    if(e.target.classList.contains('btn-edit')){
      alert('Editar serÃ¡ adicionado depois');
    }
  };
}

function routeChange(r){
  qsa('.content-block').forEach(s=>s.classList.add('hidden'));
  qs('#page-title').textContent=r==='home'?'Dashboard':r.charAt(0).toUpperCase()+r.slice(1);
  if(r==='users') qs('#users-section').classList.remove('hidden');
  if(r==='settings') qs('#settings-section').classList.remove('hidden');
}

function exportCSV(){
  let rows=[['Tipo','Valor']];
  rows.push(['UsuÃ¡rios',STATE.users.length]);
  rows.push(['Tarefas',STATE.todos.length]);
  rows.push(['Atividades',STATE.activities.length]);
  const csv=rows.map(r=>r.join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download='revitarium_export.csv';
  a.click();
  URL.revokeObjectURL(url);
}

/* ---------- Init ---------- */
async function init(){
  if(!requireAuth()) return;
  loadState();
  bindEvents();
  await renderCards();
  await renderActivityList();
  await renderTodos();
  await renderUsers();
  renderCharts();
  saveState();
}

document.addEventListener('DOMContentLoaded', init);
